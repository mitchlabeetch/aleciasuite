#!/usr/bin/expect -f
# Script de d√©ploiement interactif avec gestion du mot de passe SSH

set VPS_HOST "51.255.194.94"
set VPS_USER "ubuntu"
set timeout 1800

# Demander le mot de passe
send_user "Mot de passe SSH pour ubuntu@51.255.194.94: "
expect_user -re "(.*)\n"
set PASSWORD $expect_out(1,string)

send_user "\n============================================================\n"
send_user "ALECIA SUITE - D√âPLOIEMENT VERS VPS\n"
send_user "============================================================\n\n"

# √âtape 1: Synchronisation du code
send_user "üì¶ √âtape 1/4 : Synchronisation du code vers le VPS...\n\n"

spawn rsync -avz --delete \
  --exclude node_modules \
  --exclude .next \
  --exclude dist \
  --exclude build \
  --exclude .git \
  --exclude .env.local \
  --exclude infrastructure/repos \
  --exclude .turbo \
  --exclude scripts/migration/data/convex-export \
  /Users/utilisateur/Desktop/alepanel/ \
  ubuntu@51.255.194.94:~/alecia/alepanel/

expect {
  "password:" {
    send "$PASSWORD\r"
    exp_continue
  }
  "Are you sure" {
    send "yes\r"
    exp_continue
  }
  eof
}

wait
if {[lindex $expect_out(buffer) 0] != 0} {
  send_user "‚ùå Erreur lors de la synchronisation\n"
  exit 1
}

send_user "‚úÖ Code synchronis√©\n\n"

# √âtape 2: Build des images
send_user "üî® √âtape 2/4 : Build des images Docker personnalis√©es...\n\n"

spawn ssh -o StrictHostKeyChecking=no ubuntu@51.255.194.94

expect {
  "password:" {
    send "$PASSWORD\r"
  }
}

expect "ubuntu@*"

send "cd ~/alecia/alepanel\r"
expect "ubuntu@*"

send "echo '[1/5] Building Website (Next.js 15)...'\r"
expect "ubuntu@*"
send "docker build -f apps/website/Dockerfile -t alecia/website:latest .\r"
expect {
  "Successfully built" {
    send_user "‚úÖ Website built\n"
  }
  "ERROR" {
    send_user "‚ùå Error building website\n"
    exit 1
  }
  timeout {
    send_user "‚è±Ô∏è Timeout building website\n"
    exit 1
  }
}
expect "ubuntu@*"

send "echo '[2/5] Building Colab (Next.js 16)...'\r"
expect "ubuntu@*"
send "docker build -f apps/colab/Dockerfile -t alecia/colab:latest .\r"
expect {
  "Successfully built" {
    send_user "‚úÖ Colab built\n"
  }
  "ERROR" {
    send_user "‚ùå Error building colab\n"
    exit 1
  }
  timeout {
    send_user "‚è±Ô∏è Timeout building colab\n"
    exit 1
  }
}
expect "ubuntu@*"

send "echo '[3/5] Building Hocuspocus (WebSocket)...'\r"
expect "ubuntu@*"
send "docker build -f services/hocuspocus/Dockerfile -t alecia/hocuspocus:latest services/hocuspocus/\r"
expect {
  "Successfully built" {
    send_user "‚úÖ Hocuspocus built\n"
  }
  "ERROR" {
    send_user "‚ùå Error building hocuspocus\n"
    exit 1
  }
  timeout {
    send_user "‚è±Ô∏è Timeout building hocuspocus\n"
    exit 1
  }
}
expect "ubuntu@*"

send "echo '[4/5] Building CMS (Strapi CE)...'\r"
expect "ubuntu@*"
send "docker build -f services/cms/Dockerfile -t alecia/cms:latest services/cms/\r"
expect {
  "Successfully built" {
    send_user "‚úÖ CMS built\n"
  }
  "ERROR" {
    send_user "‚ùå Error building cms\n"
    exit 1
  }
  timeout {
    send_user "‚è±Ô∏è Timeout building cms\n"
    exit 1
  }
}
expect "ubuntu@*"

send "echo '[5/5] Building Flows (Activepieces)...'\r"
expect "ubuntu@*"
send "docker build -f services/flows/Dockerfile -t alecia/flows:latest services/flows/\r"
expect {
  "Successfully built" {
    send_user "‚úÖ Flows built\n"
  }
  "ERROR" {
    send_user "‚ùå Error building flows\n"
    exit 1
  }
  timeout {
    send_user "‚è±Ô∏è Timeout building flows\n"
    exit 1
  }
}
expect "ubuntu@*"

send "docker images | grep alecia\r"
expect "ubuntu@*"

# √âtape 3: D√©ploiement
send_user "\nüöÄ √âtape 3/4 : D√©ploiement de la stack compl√®te...\n\n"

send "docker compose --env-file .env -f docker-compose.production.yml down\r"
expect "ubuntu@*"

send "docker compose --env-file .env -f docker-compose.production.yml up -d\r"
expect "ubuntu@*"

send "sleep 10\r"
expect "ubuntu@*"

send "docker compose --env-file .env -f docker-compose.production.yml ps\r"
expect "ubuntu@*"

send "exit\r"
expect eof

send_user "\n============================================================\n"
send_user "‚úÖ D√âPLOIEMENT TERMIN√â\n"
send_user "============================================================\n\n"
