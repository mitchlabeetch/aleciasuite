{
  "name": "Deal Closing Automation",
  "description": "Final deal closing workflow with document archival and notifications",
  "version": 1,
  "trigger": {
    "type": "PIECE_TRIGGER",
    "settings": {
      "pieceName": "alecia-pipeline",
      "triggerName": "on-deal-stage-changed",
      "input": {
        "targetStage": "closing"
      }
    }
  },
  "actions": [
    {
      "name": "export_valuation",
      "displayName": "Export Final Valuation Report",
      "type": "PIECE",
      "settings": {
        "pieceName": "alecia-financial",
        "actionName": "export-valuation-to-excel",
        "input": {
          "valuationId": "{{trigger.output.metadata.valuation_id}}",
          "includeAssumptions": true,
          "includeComparables": true
        }
      }
    },
    {
      "name": "generate_final_documents",
      "displayName": "Generate Closing Documents",
      "type": "CODE",
      "settings": {
        "code": "// Generate final closing documents list\nconst documents = [\n  'Signed LOI',\n  'Share Purchase Agreement',\n  'Due Diligence Reports',\n  'Valuation Report',\n  'Board Resolutions',\n  'Regulatory Approvals'\n];\n\nreturn { documents, dealId: trigger.output.dealId };"
      }
    },
    {
      "name": "send_final_signature_request",
      "displayName": "Send Final Documents for Signature",
      "type": "PIECE",
      "settings": {
        "pieceName": "alecia-esign",
        "actionName": "send-signature-request",
        "input": {
          "docusealUrl": "https://sign.alecia.fr",
          "apiKey": "{{connections.docuseal.api_key}}",
          "templateId": "{{trigger.output.metadata.spa_template_id}}",
          "signers": [\n            {\n              "email": "{{trigger.output.metadata.buyer_email}}",\n              "name": "{{trigger.output.metadata.buyer_name}}",\n              "role": "Buyer"\n            },\n            {\n              "email": "{{trigger.output.metadata.seller_email}}",\n              "name": "{{trigger.output.metadata.seller_name}}",\n              "role": "Seller"\n            }\n          ],
          "subject": "Closing Documents - {{trigger.output.title}}",
          "message": "Veuillez signer les documents de closing ci-joints.",
          "expiresAt": "{{DATE_ADD(NOW, 30, 'days')}}"
        }
      }
    },
    {
      "name": "archive_to_minio",
      "displayName": "Archive All Deal Documents",
      "type": "CODE",
      "settings": {
        "code": "// Archive all deal documents to Minio\nconst { Pool } = require('pg');\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL });\n\n// Get all documents for this deal\nconst docs = await pool.query(\n  'SELECT * FROM shared.deal_documents WHERE deal_id = $1',\n  [trigger.output.dealId]\n);\n\nawait pool.end();\n\n// Create archive manifest\nreturn {\n  dealId: trigger.output.dealId,\n  totalDocuments: docs.rows.length,\n  archivePath: `deals/${trigger.output.dealId}/archive_${Date.now()}`,\n  documents: docs.rows\n};"
      }
    },
    {
      "name": "update_deal_status",
      "displayName": "Mark Deal as Closed Won",
      "type": "PIECE",
      "settings": {
        "pieceName": "alecia-pipeline",
        "actionName": "update-deal-stage",
        "input": {
          "dealId": "{{trigger.output.dealId}}",
          "newStage": "closed_won",
          "notes": "Deal closed successfully. All documents signed and archived.",
          "updatedBy": "system"
        }
      }
    },
    {
      "name": "send_celebration_email",
      "displayName": "Send Team Celebration Email",
      "type": "PIECE",
      "settings": {
        "pieceName": "alecia-notifications",
        "actionName": "send-email-notification",
        "input": {
          "accessToken": "{{connections.microsoft.access_token}}",
          "to": "{{trigger.output.assignedTo}}",
          "subject": "ðŸŽ‰ Deal Closed - {{trigger.output.title}}",
          "body": "<h2 style='color: #10b981;'>FÃ©licitations! ðŸŽ‰</h2><p>Le deal <strong>{{trigger.output.title}}</strong> a Ã©tÃ© officiellement clÃ´turÃ©!</p><p><strong>DÃ©tails:</strong></p><ul><li>Valeur finale: {{trigger.output.targetValue}} EUR</li><li>Date de closing: {{NOW}}</li><li>Documents archivÃ©s: {{steps.archive_to_minio.output.totalDocuments}}</li></ul><p>Excellent travail d'Ã©quipe!</p>",
          "priority": "normal"
        }
      }
    },
    {
      "name": "create_post_deal_tasks",
      "displayName": "Create Post-Deal Integration Tasks",
      "type": "CODE",
      "settings": {
        "code": "// Create post-deal integration tasks\nconst { Pool } = require('pg');\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL });\n\nconst tasks = [\n  { title: 'Integration planning', dueDate: 'DATE_ADD(NOW, 7, \"days\")' },\n  { title: '100-day plan', dueDate: 'DATE_ADD(NOW, 14, \"days\")' },\n  { title: 'Cultural integration', dueDate: 'DATE_ADD(NOW, 30, \"days\")' }\n];\n\nfor (const task of tasks) {\n  await pool.query(\n    `INSERT INTO alecia_bi.tasks (title, deal_id, assigned_to, due_date, status, created_at)\n     VALUES ($1, $2, $3, $4, 'pending', NOW())`,\n    [task.title, trigger.output.dealId, trigger.output.assignedTo[0], task.dueDate]\n  );\n}\n\nawait pool.end();\n\nreturn { tasksCreated: tasks.length };"
      }
    }
  ]
}
